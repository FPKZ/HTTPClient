name: Release e Distribuicao Automatica
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Wine (Fix for Windows Build)
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y wine64 wine32 mono-devel ca-certificates

      - name: Build App
        run: |
          npm install
          npm run build
          chmod +x ./node_modules/app-builder-bin/linux/x64/app-builder
          npx electron-builder --linux --win -p always
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- PARTE 1: UBUNTU (APT) ---
      - name: Enviar para Cloudsmith
        run: |
          pip install cloudsmith-cli
          cloudsmith push deb fpkz/httpclient/any-distro/any-version dist_electron/*.deb --api-key ${{ secrets.CLOUDSMITH_API_KEY }}

      # --- PARTE 2: ARCH (AUR) ---
      - name: Atualizar AUR
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          SHA256=$(sha256sum dist_electron/*.deb | head -n 1 | cut -d ' ' -f 1)

          # 1. Configurar Chave SSH
          mkdir -p ~/.ssh
          cat <<EOF > ~/.ssh/id_ed25519
          ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          EOF
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -t ed25519 aur.archlinux.org >> ~/.ssh/known_hosts

          # 2. Clonar repositório
          git clone ssh://aur@aur.archlinux.org/httpclient-bin.git aur_folder
          cd aur_folder

          # 3. Gerar PKGBUILD
          cat <<EOF > PKGBUILD
          pkgname=httpclient-bin
          pkgver=$VERSION
          pkgrel=1
          arch=('x86_64')
          depends=('libnss3' 'at-spi2-core' 'libasound2')
          source=("https://github.com/${{ github.repository }}/releases/download/v\$pkgver/HTTPClient-\$pkgver-linux.deb")
          sha256sums=('$SHA256')
          package() {
            tar -xzf data.tar.xz -C "\${pkgdir}/"
          }
          EOF

          # 4. Docker: Gerar .SRCINFO e devolver a permissão para o usuário do GitHub (UID 1001)
          docker run --rm -v $(pwd):/pkg archlinux:latest bash -c "
            pacman -Syu --noconfirm binutils sudo && 
            useradd -m builder && 
            chown -R builder:builder /pkg && 
            cd /pkg && 
            sudo -u builder makepkg --printsrcinfo > .SRCINFO &&
            chown -R 1001:1001 /pkg"

          # 5. Git Push (Agora com permissão restaurada)
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add PKGBUILD .SRCINFO
          git commit -m "Update to $VERSION"
          git push origin master
